FROM n8nio/n8n:1.106.3

USER root

# Install build tools needed for some npm packages
RUN apk add --no-cache --virtual .build-deps \
    python3 \
    make \
    g++

# Create directories
RUN mkdir -p /data

# Copy custom nodes directly to node_modules with proper names
COPY ./n8n/custom-nodes/n8n-nodes-hierarchicalSummarization /usr/local/lib/node_modules/n8n-nodes-hierarchicalSummarization
COPY ./n8n/custom-nodes/n8n-nodes-haystack /usr/local/lib/node_modules/n8n-nodes-haystack
COPY ./n8n/custom-nodes/n8n-nodes-citationchecker /usr/local/lib/node_modules/n8n-nodes-citationchecker
COPY ./n8n/custom-nodes/n8n-nodes-deepseek /usr/local/lib/node_modules/n8n-nodes-deepseek
COPY ./n8n/custom-nodes/n8n-nodes-yake /usr/local/lib/node_modules/n8n-nodes-yake
COPY ./n8n/custom-nodes/n8n-nodes-bitnet /usr/local/lib/node_modules/n8n-nodes-bitnet
COPY ./n8n/custom-nodes/n8n-nodes-unstructured /usr/local/lib/node_modules/n8n-nodes-unstructured
COPY ./n8n/custom-nodes/n8n-nodes-citation-gen /usr/local/lib/node_modules/n8n-nodes-citation-gen

# Remove preinstall script from deepseek that requires pnpm
RUN sed -i '/"preinstall":/d' /usr/local/lib/node_modules/n8n-nodes-deepseek/package.json

# Install dependencies for each custom node
RUN cd /usr/local/lib/node_modules/n8n-nodes-hierarchicalSummarization && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-haystack && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-citationchecker && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-deepseek && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-yake && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-bitnet && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-unstructured && npm install --production --no-save && \
    cd /usr/local/lib/node_modules/n8n-nodes-citation-gen && npm install --production --no-save

# Clean up build dependencies
RUN apk del .build-deps

# Create the custom directory structure for n8n
# n8n v1.100.1 expects custom nodes in the user folder
RUN mkdir -p /data/.n8n/custom

# Copy the complete node packages with correct structure
RUN cp -r /usr/local/lib/node_modules/n8n-nodes-hierarchicalSummarization /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-haystack /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-citationchecker /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-deepseek /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-yake /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-bitnet /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-unstructured /data/.n8n/custom/ && \
    cp -r /usr/local/lib/node_modules/n8n-nodes-citation-gen /data/.n8n/custom/

# Set proper ownership for all n8n directories
RUN chown -R node:node /data

USER node

ENV N8N_USER_FOLDER=/data
ENV NODE_PATH=/usr/local/lib/node_modules:/usr/lib/node_modules
ENV N8N_CUSTOM_EXTENSIONS=/data/.n8n/custom

# Use the standard n8n entrypoint
ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]