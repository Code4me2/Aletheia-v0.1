version: '3.8'

services:
  # Unified Document Processor Service
  unified-processor:
    build:
      context: .
      dockerfile: court-processor/Dockerfile
    container_name: unified-processor
    environment:
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-postgres}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - COURTLISTENER_API_KEY=${COURTLISTENER_API_KEY}
      - UNSTRUCTURED_SERVICE_URL=http://unstructured-service:8880
      - LOG_LEVEL=INFO
    ports:
      - "8090:8090"
    depends_on:
      - db
      - unstructured-service
    volumes:
      - ./court-processor:/app
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        echo 'Installing unified processor dependencies...' &&
        pip install aiohttp &&
        echo 'Starting unified processor API...' &&
        python unified_api.py
      "

  # Run database migrations
  unified-db-migrate:
    image: postgres:13
    environment:
      - PGHOST=db
      - PGPORT=5432
      - PGDATABASE=${DB_NAME:-postgres}
      - PGUSER=${DB_USER:-postgres}
      - PGPASSWORD=${DB_PASSWORD:-postgres}
    depends_on:
      - db
    volumes:
      - ./court-processor/migrations:/migrations
    networks:
      - app-network
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 5 &&
        echo 'Running migrations...' &&
        psql -f /migrations/create_unified_opinions_table.sql &&
        echo 'Migrations complete!'
      "

networks:
  app-network:
    external: true
    name: aletheia-v01_default